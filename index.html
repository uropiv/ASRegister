<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Registro de Asistencia</title>
  <style>
    body{font-family:Arial;margin:2rem;max-width:720px}
    label{display:block;margin-top:1rem;font-weight:bold}
    input{width:100%;padding:.5rem;margin-top:.3rem;border:1px solid #ccc;border-radius:4px}
    button{padding:.6rem 1rem;font-size:1rem;border:none;border-radius:6px;color:white;margin-top:1rem}
    #btnInicio{background:#28a745} /* Verde */
    #btnFin{background:#dc3545}   /* Rojo */
    button:disabled{opacity:0.6;cursor:not-allowed}
    #status{margin-top:1rem;font-weight:bold}
  </style>
</head>
<body>
  <h1>Control de Asistencia</h1>
  <p>Complete sus datos personales antes de marcar asistencia.</p>

  <!-- üîπ Datos del usuario -->
  <label for="legajo">Legajo Personal</label>
  <input id="legajo" type="text" placeholder="Ej: 12345">

  <label for="jerarquia">Jerarqu√≠a</label>
  <input id="jerarquia" type="text" placeholder="Ej: Cabo, Sargento, etc.">

  <label for="apellidoNombre">Apellido y Nombre</label>
  <input id="apellidoNombre" type="text" placeholder="Ej: P√©rez Juan">

  <label for="dni">Documento Nacional de Identidad (DNI)</label>
  <input id="dni" type="text" placeholder="Ej: 12345678">

  <!-- üîπ Botones -->
  <button id="btnInicio">Iniciar servicio</button>
  <button id="btnFin">Finalizar servicio</button>
  <p id="status"></p>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUCqj3sK2YikqjTJ5MZ6OW-1xaPewPE0JFDkHC-Ph_ekZj-dXk0wkdcYNMNNVEeSyR/exec"; 
    const status = document.getElementById('status');
    const btnInicio = document.getElementById('btnInicio');
    const btnFin = document.getElementById('btnFin');

    // üîπ Cargar datos guardados al abrir la p√°gina
    window.onload = () => {
      if (localStorage.getItem("legajo")) document.getElementById("legajo").value = localStorage.getItem("legajo");
      if (localStorage.getItem("jerarquia")) document.getElementById("jerarquia").value = localStorage.getItem("jerarquia");
      if (localStorage.getItem("apellidoNombre")) document.getElementById("apellidoNombre").value = localStorage.getItem("apellidoNombre");
      if (localStorage.getItem("dni")) document.getElementById("dni").value = localStorage.getItem("dni");
    };

    // üîπ Guardar datos en el navegador
    function guardarDatos(legajo, jerarquia, apellidoNombre, dni) {
      localStorage.setItem("legajo", legajo);
      localStorage.setItem("jerarquia", jerarquia);
      localStorage.setItem("apellidoNombre", apellidoNombre);
      localStorage.setItem("dni", dni);
    }

    // üîπ Funci√≥n que env√≠a datos al Apps Script
    async function sendToGAS(payload) {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    // üîπ Funci√≥n para registrar inicio o fin
    async function registrar(tipo) {
      const legajo = document.getElementById('legajo').value.trim();
      const jerarquia = document.getElementById('jerarquia').value.trim();
      const apellidoNombre = document.getElementById('apellidoNombre').value.trim();
      const dni = document.getElementById('dni').value.trim();

      if (!legajo || !jerarquia || !apellidoNombre || !dni) {
        status.textContent = '‚ö†Ô∏è Complete todos los campos antes de continuar.';
        return;
      }

      // Guardar en el navegador
      guardarDatos(legajo, jerarquia, apellidoNombre, dni);

      status.textContent = 'üìç Solicitando ubicaci√≥n...';
      btnInicio.disabled = true;
      btnFin.disabled = true;

      if (!navigator.geolocation) {
        status.textContent = 'Geolocalizaci√≥n no soportada.';
        btnInicio.disabled = false;
        btnFin.disabled = false;
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const payload = {
          legajo: legajo,
          jerarquia: jerarquia,
          apellidoNombre: apellidoNombre,
          dni: dni,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          tipo: tipo
        };

        status.textContent = 'üì§ Enviando...';
        try {
          const r = await sendToGAS(payload);
          if (r && r.status === 'ok') {
            status.textContent = `‚úÖ Registro de ${tipo} guardado correctamente.`;
          } else {
            status.textContent = '‚ö†Ô∏è Respuesta del servidor: ' + JSON.stringify(r);
          }
        } catch (err) {
          status.textContent = '‚ùå Error: ' + err.message;
        } finally {
          btnInicio.disabled = false;
          btnFin.disabled = false;
        }
      }, (err) => {
        status.textContent = '‚ùå Error de geolocalizaci√≥n: ' + err.message;
        btnInicio.disabled = false;
        btnFin.disabled = false;
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    // üîπ Eventos de los botones
    btnInicio.addEventListener('click', () => registrar('INICIO'));
    btnFin.addEventListener('click', () => registrar('FIN'));
  </script>
</body>
</html>

