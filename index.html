<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registro de Asistencia - Vialidad Nacional</title>
<style>
/* 🔹 (se mantiene TODO tu CSS original) */

/* Estilo para el campo Novedades */
textarea {
  width: 100%;
  min-height: 80px;
  padding: 0.8rem;
  border-radius: 15px;
  background: #003366;
  color: #cce6ff;
  font-size: 1rem;
  margin-bottom: 1.8rem;
  display: none;
}
#labelNovedades { display:none; }
#btnSinNovedades {
  display:none;
  margin-bottom:1.8rem;
  padding:0.6rem 1rem;
  border-radius:12px;
  background:#004080;
  color:#e0f7ff;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>
<body>
  <div class="container" role="main" aria-label="Formulario de control de asistencia">
    <div class="logo" tabindex="0" aria-label="Logo de la Unidad Regional de Orden Público 4">
      <img src="LogoOP.png" alt="Logo Unidad Regional de Orden Público 4">
    </div>

    <h1>Control de Asistencia</h1>
    <p class="subtitle">Complete sus datos antes de marcar asistencia.</p>

    <label for="legajo">Legajo Personal</label>
    <input id="legajo" type="text" placeholder="Ej: 12345" aria-required="true" autocomplete="off">

    <label for="jerarquia">Jerarquía</label>
    <input id="jerarquia" type="text" placeholder="Ej: Cabo, Sargento, etc." aria-required="true" autocomplete="off">

    <label for="apellidoNombre">Apellido y Nombre</label>
    <input id="apellidoNombre" type="text" placeholder="Ej: Pérez Juan" aria-required="true" autocomplete="off">

    <label for="dni">Documento Nacional de Identidad (DNI)</label>
    <input id="dni" type="text" placeholder="Ej: 12345678" aria-required="true" autocomplete="off">

    <!-- 🔹 Campo Novedades solo visible en FIN -->
    <label for="novedades" id="labelNovedades">Novedades</label>
    <textarea id="novedades" placeholder="Ingrese novedades del relevo..."></textarea>
    <button type="button" id="btnSinNovedades">➖ Sin novedades</button>

    <div class="btn-group">
      <button id="btnInicio" aria-label="Iniciar servicio">Iniciar servicio</button>
      <button id="btnFin" aria-label="Finalizar servicio">Finalizar servicio</button>
    </div>

    <p id="status" role="alert" aria-live="polite"></p>
  </div>

  <div class="badge" id="badge">✔ Registro enviado</div>

  <footer>
    Unidad Regional de Orden Público 4 &mdash; Todos los derechos reservados &copy; 2025
  </footer>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwBFgc2B1fH2PL7p2vG1gcCrUZYlQ_1ZWnm-YpJ-W4F_VJkYpI9AaRCE8KzYWForIqu/exec";
const status = document.getElementById('status');
const btnInicio = document.getElementById('btnInicio');
const btnFin = document.getElementById('btnFin');
const badge = document.getElementById('badge');
const logo = document.querySelector('.logo');

const novedadesInput = document.getElementById('novedades');
const labelNovedades = document.getElementById('labelNovedades');
const btnSinNovedades = document.getElementById('btnSinNovedades');

window.onload = () => {
  ["legajo","jerarquia","apellidoNombre","dni"].forEach(id => {
    if (localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
  });
};

// Mostrar/ocultar campo Novedades
btnInicio.addEventListener('click',()=>{
  novedadesInput.style.display='none';
  labelNovedades.style.display='none';
  btnSinNovedades.style.display='none';
});
btnFin.addEventListener('click',()=>{
  novedadesInput.style.display='block';
  labelNovedades.style.display='block';
  btnSinNovedades.style.display='inline-block';
});

// Acción rápida Sin novedades
btnSinNovedades.addEventListener('click',()=>{
  novedadesInput.value = "Sin novedades";
});

// Logo animación
logo.addEventListener('click', () => {
  logo.classList.add('active');
  setTimeout(() => logo.classList.remove('active'), 600);
});
logo.addEventListener('keydown', e => {
  if(e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    logo.click();
  }
});

function guardarDatos(legajo, jerarquia, apellidoNombre, dni){
  localStorage.setItem("legajo", legajo);
  localStorage.setItem("jerarquia", jerarquia);
  localStorage.setItem("apellidoNombre", apellidoNombre);
  localStorage.setItem("dni", dni);
}

function mostrarStatus(mensaje,tipo){
  status.textContent = mensaje;
  switch(tipo){
    case 'okInicio': status.style.color='#00ff99'; break;
    case 'okFin': status.style.color='#ff4d4d'; break;
    case 'warning': status.style.color='#ffcc00'; break;
    case 'error': status.style.color='#ff4444'; break;
    default: status.style.color='#e0e0e0';
  }
  setTimeout(()=>{status.textContent='';},5000);
  badge.textContent = mensaje;
  badge.classList.add('show');
  setTimeout(()=>{badge.classList.remove('show');},4000);
}

async function sendToGAS(payload){
  const res = await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=UTF-8'},
    body:JSON.stringify(payload)
  });
  return res.json();
}

async function registrar(tipo){
  const legajo = document.getElementById('legajo').value.trim();
  const jerarquia = document.getElementById('jerarquia').value.trim();
  const apellidoNombre = document.getElementById('apellidoNombre').value.trim();
  const dni = document.getElementById('dni').value.trim();

  if(!legajo||!jerarquia||!apellidoNombre||!dni){
    mostrarStatus('⚠️ Complete todos los campos.','warning');
    return;
  }

  guardarDatos(legajo,jerarquia,apellidoNombre,dni);
  mostrarStatus('📍 Solicitando ubicación...','warning');
  btnInicio.disabled=true; btnFin.disabled=true;

  if(!navigator.geolocation){
    mostrarStatus('❌ Geolocalización no soportada.','error');
    btnInicio.disabled=false; btnFin.disabled=false;
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const payload={
      legajo, jerarquia, apellidoNombre, dni,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      accuracy: pos.coords.accuracy,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      tipo
    };

    // Solo agregar novedades si es FIN
    if(tipo==='FIN'){
      payload.novedades = novedadesInput.value.trim() || "Sin novedades";
    }

    mostrarStatus('📤 Enviando...','warning');
    try{
      const r = await sendToGAS(payload);
      if(r && r.status==='ok'){
        mostrarStatus(tipo==='INICIO'?'✅ Registro de INICIO guardado.':'🛑 Registro de FIN guardado.',tipo==='INICIO'?'okInicio':'okFin');
      }else{
        mostrarStatus('⚠️ Respuesta del servidor: '+JSON.stringify(r),'warning');
      }
    }catch(err){
      mostrarStatus('❌ Error: '+err.message,'error');
    }finally{
      btnInicio.disabled=false; btnFin.disabled=false;
    }
  },err=>{
    mostrarStatus('❌ Error de geolocalización: '+err.message,'error');
    btnInicio.disabled=false; btnFin.disabled=false;
  },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
}

btnInicio.addEventListener('click',()=>registrar('INICIO'));
btnFin.addEventListener('click',()=>registrar('FIN'));
</script>
</body>
</html>
