<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Registro de Asistencia</title>
  <style>
    body{font-family:Arial;margin:2rem;max-width:720px}
    label{display:block;margin-top:1rem;font-weight:bold}
    input{width:100%;padding:.5rem;margin-top:.3rem;border:1px solid #ccc;border-radius:4px}
    button{padding:.6rem 1rem;font-size:1rem;border:none;border-radius:6px;color:white;margin-top:1rem}
    #btnInicio{background:#28a745} /* Verde */
    #btnFin{background:#dc3545}   /* Rojo */
    button:disabled{opacity:0.6;cursor:not-allowed}
    #status{margin-top:1rem;font-weight:bold;transition: all 0.5s ease;}
  </style>
</head>
<body>
  <h1>Control de Asistencia</h1>
  <p>Complete sus datos personales antes de marcar asistencia.</p>

  <!-- Datos del usuario -->
  <label for="legajo">Legajo Personal</label>
  <input id="legajo" type="text" placeholder="Ej: 12345">

  <label for="jerarquia">Jerarqu√≠a</label>
  <input id="jerarquia" type="text" placeholder="Ej: Cabo, Sargento, etc.">

  <label for="apellidoNombre">Apellido y Nombre</label>
  <input id="apellidoNombre" type="text" placeholder="Ej: P√©rez Juan">

  <label for="dni">Documento Nacional de Identidad (DNI)</label>
  <input id="dni" type="text" placeholder="Ej: 12345678">

  <!-- Botones -->
  <button id="btnInicio">Iniciar servicio</button>
  <button id="btnFin">Finalizar servicio</button>
  <p id="status"></p>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUCqj3sK2YikqjTJ5MZ6OW-1xaPewPE0JFDkHC-Ph_ekZj-dXk0wkdcYNMNNVEeSyR/exec"; 
    const status = document.getElementById('status');
    const btnInicio = document.getElementById('btnInicio');
    const btnFin = document.getElementById('btnFin');

    // üîπ Cargar datos guardados al abrir la p√°gina
    window.onload = () => {
      ["legajo","jerarquia","apellidoNombre","dni"].forEach(id => {
        if (localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
      });
    };

    // üîπ Guardar datos en el navegador
    function guardarDatos(legajo, jerarquia, apellidoNombre, dni) {
      localStorage.setItem("legajo", legajo);
      localStorage.setItem("jerarquia", jerarquia);
      localStorage.setItem("apellidoNombre", apellidoNombre);
      localStorage.setItem("dni", dni);
    }

    // üîπ Funci√≥n para mostrar mensajes con color, emoji y desaparecimiento
    function mostrarStatus(mensaje, tipo) {
      status.textContent = mensaje;
      switch(tipo) {
        case 'okInicio': status.style.color = 'green'; break;
        case 'okFin': status.style.color = 'red'; break;
        case 'warning': status.style.color = 'orange'; break;
        case 'error': status.style.color = 'darkred'; break;
        default: status.style.color = 'black';
      }
      // Desaparece autom√°ticamente despu√©s de 5 segundos
      setTimeout(() => { status.textContent = ''; }, 5000);
    }

    // üîπ Funci√≥n que env√≠a datos al Apps Script
    async function sendToGAS(payload) {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    // üîπ Funci√≥n para registrar inicio o fin
    async function registrar(tipo) {
      const legajo = document.getElementById('legajo').value.trim();
      const jerarquia = document.getElementById('jerarquia').value.trim();
      const apellidoNombre = document.getElementById('apellidoNombre').value.trim();
      const dni = document.getElementById('dni').value.trim();

      if (!legajo || !jerarquia || !apellidoNombre || !dni) {
        mostrarStatus('‚ö†Ô∏è Complete todos los campos antes de continuar.', 'warning');
        return;
      }

      guardarDatos(legajo, jerarquia, apellidoNombre, dni);

      mostrarStatus('üìç Solicitando ubicaci√≥n...', 'warning');
      btnInicio.disabled = true;
      btnFin.disabled = true;

      if (!navigator.geolocation) {
        mostrarStatus('‚ùå Geolocalizaci√≥n no soportada.', 'error');
        btnInicio.disabled = false;
        btnFin.disabled = false;
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const payload = {
          legajo: legajo,
          jerarquia: jerarquia,
          apellidoNombre: apellidoNombre,
          dni: dni,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          tipo: tipo
        };

        mostrarStatus('üì§ Enviando...', 'warning');
        try {
          const r = await sendToGAS(payload);
          if (r && r.status === 'ok') {
            mostrarStatus(tipo === 'INICIO' ? '‚úÖ Registro de INICIO guardado correctamente.' : 'üõë Registro de FIN guardado correctamente.', tipo === 'INICIO' ? 'okInicio' : 'okFin');
          } else {
            mostrarStatus('‚ö†Ô∏è Respuesta del servidor: ' + JSON.stringify(r), 'warning');
          }
        } catch (err) {
          mostrarStatus('‚ùå Error: ' + err.message, 'error');
        } finally {
          btnInicio.disabled = false;
          btnFin.disabled = false;
        }
      }, (err) => {
        mostrarStatus('‚ùå Error de geolocalizaci√≥n: ' + err.message, 'error');
        btnInicio.disabled = false;
        btnFin.disabled = false;
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    // üîπ Eventos de los botones
    btnInicio.addEventListener('click', () => registrar('INICIO'));
    btnFin.addEventListener('click', () => registrar('FIN'));
  </script>
</body>
</html>
